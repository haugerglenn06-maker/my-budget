<!-- main app -->
<!DOCTYPE html>
<html lang="sv">
    <head>
        <meta charset="UTF-8" />
        <title>Budget Master - Lagerstigen 11</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    </head>
    <body class="bg-slate-900 text-white p-8">
        <div class="max-w-4xl mx-auto">
            <header
                class="flex justify-between items-center mb-8 bg-slate-800 p-6 rounded-2xl border border-slate-700"
            >
                <div>
                    <h1 class="text-3xl font-bold text-blue-400">
                        Budget Master
                    </h1>
                    <p class="text-slate-400">
                        ID:
                        <span class="font-mono text-white">lagerstigen-11</span>
                    </p>
                </div>
                <div
                    id="status-badge"
                    class="bg-slate-700 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest text-slate-400"
                >
                    Väntar på klient...
                </div>
            </header>

            <div class="grid grid-cols-3 gap-6">
                <div
                    class="bg-slate-800 p-6 rounded-2xl border border-slate-700 h-[500px] flex flex-col"
                >
                    <h2 class="font-bold mb-4 text-slate-400 uppercase text-sm">
                        Händelselogg
                    </h2>
                    <div
                        id="log"
                        class="text-xs font-mono space-y-2 overflow-y-auto flex-1 text-slate-500"
                    ></div>
                </div>

                <div
                    class="col-span-2 bg-slate-800 p-6 rounded-2xl border border-slate-700 min-h-[500px]"
                >
                    <h2 class="font-bold mb-4 text-slate-400 uppercase text-sm">
                        Skannade Varor
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr
                                    class="text-slate-500 border-b border-slate-700 text-sm"
                                >
                                    <th class="pb-3">Vara</th>
                                    <th class="pb-3">EAN</th>
                                    <th class="pb-3 text-right">Pris</th>
                                </tr>
                            </thead>
                            <tbody
                                id="purchase-list"
                                class="divide-y divide-slate-700"
                            ></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let db;
            const request = indexedDB.open("BudgetDB", 1);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                db.createObjectStore("purchases", {
                    keyPath: "id",
                    autoIncrement: true,
                });
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                renderPurchases();
            };

            const peer = new Peer("lagerstigen-11", {
                config: {
                    iceServers: [{ url: "stun:stun.l.google.com:19302" }],
                },
            });

            peer.on("connection", (conn) => {
                document.getElementById("status-badge").innerText =
                    "Klient Ansluten";
                document.getElementById("status-badge").className =
                    "bg-green-500/20 px-4 py-2 rounded-full text-xs font-bold text-green-500";

                conn.on("data", async (data) => {
                    log(`Mottog EAN: ${data.barcode}`);
                    await processItem(data);
                });
            });

            async function processItem(item) {
                // Slå upp produktnamn via API
                try {
                    const res = await fetch(
                        `https://world.openfoodfacts.org/api/v0/product/${item.barcode}.json`
                    );
                    const json = await res.json();
                    if (json.status === 1) {
                        item.name = json.product.product_name || "Okänd vara";
                    }
                } catch (e) {
                    log("API-fel vid uppslag");
                }

                const tx = db.transaction("purchases", "readwrite");
                tx.objectStore("purchases").add(item);
                tx.oncomplete = renderPurchases;
            }

            function renderPurchases() {
                const list = document.getElementById("purchase-list");
                list.innerHTML = "";
                db
                    .transaction("purchases")
                    .objectStore("purchases")
                    .getAll().onsuccess = (e) => {
                    e.target.result.reverse().forEach((item) => {
                        list.innerHTML += `
                        <tr class="text-sm">
                            <td class="py-4 font-medium">${item.name}</td>
                            <td class="py-4 font-mono text-slate-500">${item.barcode}</td>
                            <td class="py-4 text-right text-blue-400 font-bold">---</td>
                        </tr>`;
                    });
                };
            }

            function log(msg) {
                const el = document.getElementById("log");
                el.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
                el.scrollTop = el.scrollHeight;
            }
        </script>
    </body>
</html>
