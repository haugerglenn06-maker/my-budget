<!DOCTYPE html>
<html lang="sv">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Budget Klient - Native</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    </head>
    <body
        class="bg-[#0f172a] text-white min-h-screen p-4 flex flex-col items-center"
    >
        <div class="w-full max-w-md space-y-4">
            <div
                id="status"
                class="text-[10px] uppercase text-center text-slate-500 tracking-widest"
            >
                Väntar på start
            </div>

            <div
                class="relative aspect-square bg-black rounded-[40px] overflow-hidden border-4 border-slate-800 shadow-2xl"
            >
                <video
                    id="video"
                    autoplay
                    playsinline
                    class="w-full h-full object-cover"
                ></video>
                <div
                    class="absolute inset-0 border-[40px] border-black/40 pointer-events-none"
                ></div>
                <div
                    class="absolute top-1/2 left-0 right-0 h-1 bg-red-500/50 shadow-[0_0_15px_red] animate-pulse"
                ></div>
            </div>

            <div
                id="result-box"
                class="bg-slate-800 p-6 rounded-3xl text-center border border-slate-700"
            >
                <div id="display" class="text-2xl font-mono text-green-400">
                    Siktar...
                </div>
            </div>

            <button
                id="start-btn"
                onclick="initApp()"
                class="w-full bg-blue-600 py-5 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all"
            >
                STARTA KAMERA & ANSLUT
            </button>

            <div class="flex gap-2">
                <input
                    id="manual-input"
                    type="number"
                    placeholder="Manuell EAN"
                    class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-4 outline-none"
                />
                <button
                    onclick="sendManual()"
                    class="bg-slate-700 px-6 rounded-xl font-bold uppercase text-xs"
                >
                    Sänd
                </button>
            </div>
        </div>

        <script>
            let peer, conn, detector;
            const video = document.getElementById("video");

            async function initApp() {
                // 1. Kolla om mobilen stödjer Native Barcode Detection
                if (!("BarcodeDetector" in window)) {
                    alert(
                        "Din webbläsare stödjer inte Native Detection. Använd Chrome på Android."
                    );
                    return;
                }

                detector = new BarcodeDetector({
                    formats: ["ean_13", "ean_8", "code_128"],
                });

                // 2. Starta kameran
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                    },
                });
                video.srcObject = stream;

                // 3. Anslut till datorn
                peer = new Peer();
                peer.on("open", () => {
                    conn = peer.connect("lagerstigen-11");
                    conn.on("open", () => {
                        document.getElementById("status").innerText =
                            "ANSLUTEN ✅";
                        document
                            .getElementById("start-btn")
                            .classList.add("hidden");
                        renderLoop();
                    });
                });
            }

            async function renderLoop() {
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        const code = barcodes[0].rawValue;
                        handleFound(code);
                        return; // Stoppa loopen tillfälligt
                    }
                } catch (e) {
                    console.error(e);
                }
                requestAnimationFrame(renderLoop);
            }

            function handleFound(code) {
                document.getElementById("display").innerText = code;
                if (navigator.vibrate) navigator.vibrate(100);

                conn.send({
                    barcode: code,
                    name: "Hämtar namn...",
                    timestamp: new Date().toISOString(),
                });

                setTimeout(renderLoop, 2000); // Vänta 2 sek innan nästa skanning
            }

            function sendManual() {
                const val = document.getElementById("manual-input").value;
                if (val) handleFound(val);
            }
        </script>
    </body>
</html>
